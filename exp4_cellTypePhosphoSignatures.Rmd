---
title: "exp4_pulpPhosphoDeconvolution"
output: html_document
author: Sara Gosline
date: "2023-02-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(ggfortify)
library(cowplot)
#library(leapR)
library(dplyr)


source('spleenDataFormatting.R')
source('spatialProtUtils.R')

```

The assignment of pulp type from the basic data was not robust. Here we will use the cell type signatures from the sorted data to label the voxels.


## Voxel assignments from bulk data


```{r cell type signatures}
#run diffex for sorted prot

#score spatial prot

#assign signature scores

#map signatures to spatial data

phumap<-spat.phos%>%
  scater::runPCA()

fullmap<-scater::runPCA(phospho.sorted)

full<-doDiffEx(fullmap)

upsig<-full%>%subset(adj.P.Val<0.05)%>%subset(logFC>.25)
downsig<-full%>%subset(adj.P.Val<0.05)%>%subset(logFC<(-.25))

print(paste0('we now have a white pulp signature of ',nrow(upsig)))
print(paste0('we now have a red pulp signature of ',nrow(downsig)))

```

## Plot values in heatmap
Let's now plot the signatures in heatmaps of the original and spatial data.


```{r pressure, echo=FALSE}
library(pheatmap)


pheatmap(as.matrix(exprs(fullmap)[rownames(upsig),]),annotation_col = as.data.frame(colData(fullmap)),cellwidth = 10,main='White pulp signature', filename = 'whitePulpSorted.png')


pheatmap(as.matrix(exprs(phumap)[intersect(rownames(upsig),rownames(rowData(phumap))),]),annotation_col = as.data.frame(colData(phumap))[,c('pulpAnnotation','TMT.set')],main='White pulp signature',filename='whitePulpSpatial.png')


pheatmap(as.matrix(exprs(fullmap)[rownames(downsig),]),annotation_col = as.data.frame(colData(fullmap)),cellwidth=10,main='Red pulp signature',filename='redPulpSorted.png')


pheatmap(as.matrix(exprs(phumap)[intersect(rownames(downsig),rownames(rowData(phumap))),]),annotation_col = as.data.frame(colData(phumap))[,c('pulpAnnotation','TMT.set')],main='Red pulp signature',filename='redPulpSpatial.png')


```

These signatures cluster voxels, but don't serve as great markers because they are still very much 'down' regulated. We want to pick the top expressed proteins that represent each pulp type.

```{r reduced signature}


whitesig<-upsig#full%>%subset(adj.P.Val<0.05)%>%subset(logFC>.25)%>%subset(AveExpr>0)
redsig<-downsig#full%>%subset(adj.P.Val<0.05)%>%subset(logFC<(-.25))%>%subset(AveExpr>(0))

#print(paste0('we now have a white pulp signature of ',nrow(whitesig)))
#print(paste0('we now have a red pulp signature of ',nrow(redsig)))

#pheatmap(as.matrix(exprs(fullmap)[rownames(whitesig),]),annotation_col = as.data.frame(colData(fullmap)),cellwidth = 10,main='White pulp signature')


#pheatmap(as.matrix(exprs(pumap)[intersect(rownames(whitesig),rownames(rowData(pumap))),]),annotation_col = as.data.frame(colData(pumap))[,c('pulpAnnotation','TMT.set')],main='White pulp signature')


#pheatmap(as.matrix(exprs(fullmap)[rownames(redsig),]),annotation_col = as.data.frame(colData(fullmap)),cellwidth=10,main='Red pulp signature')


#pheatmap(as.matrix(exprs(phumap)[intersect(rownames(redsig),rownames(rowData(phumap))),]),annotation_col = as.data.frame(colData(phumap))[,c('pulpAnnotation','TMT.set')],main='Red pulp signature')

```

So we have a handful of proteins that are marking the signature. Let's see if we can link them in a biological fashion.

```{r pathway enrichment}
#library(clusterProfiler)
library(org.Hs.eg.db)
library(leapR)
map<-as.list(org.Hs.egSYMBOL2EG)

redgenes<-lapply(rownames(redsig),function(x) return(map[[x]][1]))
whitegenes<-lapply(rownames(whitesig),function(x) return(map[[x]][1]))

universe<-unlist(lapply(rownames(full),function(x) return(map[[x]][1])))

data('kinasesubstrates')

subs<-full%>%arrange(logFC)%>%
  dplyr::mutate('gene')%>%
  dplyr::select('featureID')
#red.enrich<-leapR::leapR()
#red.enrich<-enrichGO(gene=redgenes,
#                   OrgDb=org.Hs.eg.db,ont='BP',
#                  qvalueCutoff=0.05,
#                   universe=universe)

#white.enrich<-enrichGO(gene=whitegenes,
#                   OrgDb=org.Hs.eg.db,ont='BP',
#                  qvalueCutoff=0.05,
#                   universe=universe)

#goplot(red.enrich)
#goplot(white.enrich)
```

This looks more promising. We can now annotate each sample by the mean expression of the signature proteins, see if that works?

```{r calculate signature scores}

calcSigScore<-function(sce, sigProts,sigName){
  
  allranks<-apply(exprs(sce),2,function(x) rev(rank(x)))
  
  allpercs<-apply(exprs(sce),2,function(x) rev(percent_rank(x)))
  rownames(allpercs)<-rownames(exprs(sce))
  siggenes<-allpercs[intersect(rownames(allpercs),sigProts),]
  sigScore=apply(siggenes,2,mean,na.rm=TRUE)
  
  colData(sce)[[sigName]]<-sigScore
  sce
}

phumap<-calcSigScore(phumap,rownames(redsig),'RedPulp')%>%
  calcSigScore(rownames(whitesig),'WhitePulp')
  
p1<-plotPCA(phumap,color_by='WhitePulp')

p2<-plotPCA(phumap,color_by='RedPulp')

p3<-cowplot::plot_grid(p2,p1)
p3
ggsave('phos_pcaLabeledByScore.png',p3,width=12)

```

This isn't quite right - the 'green' items are definitely on the right, but we need some sort of threshold to 'call' the white vs. red pulp items.


### Plot in image

Lastly we want to plot a set of scores, in this case the signature scores, in an image. 


```{r plot image}

 p<-plotGrid(phumap,'RedPulp')

 p1<-ggplot(as.data.frame(colData(phumap)),aes(x=Xcoord,y=Ycoord,fill=WhitePulp))+
  geom_raster()+theme_bw()+scale_fill_viridis_c()+
    ggtitle(paste0("White pulp signature"))
    

 pc<-cowplot::plot_grid(p,p1)
 pc
 ggsave('phosscoredImage.png',pc,width=12)
```

Now that we have a rank score, we can "call" each voxel. 


```{r voxel scoring}

cols<-list(red='darkred',white='white',None='darkgrey',Both='darkorange')
newDat<-colData(phumap)%>%
  as.data.frame()%>%
  mutate(isRed=RedPulp>0.5,isWhite=WhitePulp>0.5)%>%
  mutate(pulp=ifelse(isRed,ifelse(isWhite,'Both','red'),ifelse(isWhite,'white','None')))

p1<-ggplot(newDat)+geom_point(aes(x=RedPulp,y=WhitePulp,col=pulp))+scale_color_manual(values=cols)

p2<-ggplot(newDat,aes(x=Xcoord,y=Ycoord,fill=pulp))+geom_raster()+scale_fill_manual(values=cols)

res<-cowplot::plot_grid(p1,p2)
res
ggsave('phosassignedVals.png',res,width=12)
```



